# nx-ms-server-gateway

## π“ λ””λ ‰ν† λ¦¬ κµ¬μ΅°

```bash
src
β”β”€β”€ auth # μΈμ¦ μ„λ²„ ν†µμ‹  λ¨λ“ (μ»¨νΈλ΅¤λ¬, μ„λΉ„μ¤, λ¨λ“ λ“±)
β”‚ β”β”€β”€ auth.controller.spec.ts # μΈμ¦ μ»¨νΈλ΅¤λ¬ ν…μ¤νΈ
β”‚ β”β”€β”€ auth.controller.ts # μΈμ¦ API μ”μ²­ μ²λ¦¬
β”‚ β”β”€β”€ auth.module.ts # μΈμ¦ λ¨λ“
β”‚ β””β”€β”€ auth.service.ts # μΈμ¦ μ„λΉ„μ¤ λ΅μ§
β”‚
β”β”€β”€ common # κ³µν†µ λ¨λ“ λ¨μ (μ ν‹Έ, λ°μ½”λ μ΄ν„°, μΈν„°μ…‰ν„° λ“±)
β”‚ β”β”€β”€ constants # μƒμ μ •μ
β”‚ β”‚ β”β”€β”€ index.ts
β”‚ β”‚ β””β”€β”€ roles.ts # μ—­ν• (Role) κ΄€λ ¨ μƒμ
β”‚ β”β”€β”€ decorator # μ»¤μ¤ν…€ λ°μ½”λ μ΄ν„° μ •μ
β”‚ β”‚ β”β”€β”€ public.decorator.ts # open API ν‘κΈ°λ¥Ό μ„ν• decorator
β”‚ β”‚ β””β”€β”€ roles.decorator.ts # μ—­ν•  λ°°μ—΄ μ£Όμ…μ„ μ„ν• decorator
β”‚ β”β”€β”€ guard # μΈμ¦/μΈκ°€ κ΄€λ ¨ κ°€λ“
β”‚ β”‚ β”β”€β”€ jwt-auth.guard.ts # isPublic λλ” @nestjs/passport ν†µκ³Ό μΈ κ²½μ° ν—μ©
β”‚ β”‚ β””β”€β”€ roles.guard.ts # Roles decorator λ΅λ¶€ν„° μ£Όμ…λ°›μ€ κ¶ν• λ©λ΅μ— ν¬ν•¨λ κ²½μ°, λλ” ANONYMOUS λ€μƒμΈ κ²½μ° ν—μ©
β”‚ β”β”€β”€ interceptors # μΈν„°μ…‰ν„° λ¨μ
β”‚ β”‚ β””β”€β”€ log.interceptor.ts # μ”μ²­/μ‘λ‹µ λ΅κΉ… μΈν„°μ…‰ν„°
β”‚ β”β”€β”€ strategy # Passport μ „λµ κµ¬ν„
β”‚ β”‚ β””β”€β”€ jwt.strategy.ts # scret-key λ΅ μΈμ¦λλ©΄ ν—μ©
β”‚ β””β”€β”€ types # κ³µν†µ νƒ€μ… μ •μ
β”‚ β””β”€β”€ index.ts
β”‚
β”β”€β”€ event # μ΄λ²¤νΈ μ„λ²„ ν†µμ‹  λ¨λ“
β”‚ β”β”€β”€ types # μ΄λ²¤νΈ κ΄€λ ¨ νƒ€μ… μ •μ
β”‚ β”β”€β”€ event.controller.spec.ts
β”‚ β”β”€β”€ event.controller.ts
β”‚ β”β”€β”€ event.module.ts
β”‚ β”β”€β”€ event.service.spec.ts
β”‚ β””β”€β”€ event.service.ts
β”‚
β”β”€β”€ proxy # μ™Έλ¶€ μ”μ²­ ν”„λ΅μ‹ μ²λ¦¬ (HTTP Proxy)
β”‚ β”β”€β”€ http-proxy.service.ts # ν”„λ΅μ‹ μ”μ²­ κµ¬ν„ μ„λΉ„μ¤
β”‚ β””β”€β”€ proxy.module.ts
β”‚
β”β”€β”€ app.controller.spec.ts # μ•± μ§„μ…μ  μ»¨νΈλ΅¤λ¬ ν…μ¤νΈ
β”β”€β”€ app.module.ts # λ£¨νΈ λ¨λ“
β””β”€β”€ main.ts # μ• ν”λ¦¬μΌ€μ΄μ… λ¶€νΈμ¤νΈλ©
```

---

## μ„¤κ³„ λ°°κ²½

0. κ°λ° μ‘μ—… μ§„μ „μ— μμ–΄ ν™κ²½ κµ¬μ„±μ΄ κ°€μ¥ μ¤‘μ”ν•κ³  μ¤λ κ±Έλ¦°λ‹¤κ³  μƒκ°ν•΄μ„ κ°€μ¥ λ¨Όμ € μ‘μ—…μ„ μ‹μ‘ν–μµλ‹λ‹¤.

1. RolesGuardμ™€ JwtGuardλ¥Ό λ¨λ‘ μ‚¬μ©ν•μ—¬ μ „μ—­ μ μ©ν•μ€μµλ‹λ‹¤.

2. ν•μ§€λ§ μ΄λ²¤νΈμ λ©λ΅ λ“± μΌλ¶€ APIλ” κ¶ν•μ΄ μ—†λ” μ μ €λ„ λ³Ό μ μμ–΄μ•Ό ν•λ‹¤κ³  μƒκ°ν•΄μ„ Pubcic λ°μ½”λ μ΄ν„°, μ μ € μ—­ν• μ— ANONYMOUSλ¥Ό μ¶”κ°€ν•΄λ‘μ—μµλ‹λ‹¤.

3. μ”μ²­/μ‘λ‹µ λ΅κ·Έκ°€ ν•„μ”ν•λ‹¤κ³  μƒκ°ν•΄μ„ interceptor κµ¬ν„ν•μ—¬ μ „μ—­ λ“±λ΅ν•μ€κ³ , μ΄λ” 3κ°μ μ„λ²„μ— λ™μΌν•κ² λ“±λ΅ν•μ—¬ gwμ™€ μ„λ²„ κ°„μ ν†µμ‹  μ—¬λ¶€μ™€ λ°μ΄ν„° μ΄λ™ κ³Όμ • ν™•μΈμ„ μ„ν•΄μ„λ„ μ‚¬μ©λμµλ‹λ‹¤.

4. gatewayλ” κΈ°λ³Έμ μΌλ΅ μ„λΉ„μ¤κ°€ μ•„λ‹ λ³΄μ•μ λ©μ μ΄λΌκ³  μΈμ§€ν•κ³  μμµλ‹λ‹¤. λ”°λΌμ„ μ—°κ²°λλ” DBλ” κµ¬μ„±ν•μ§€ μ•μ•κ³  jwtμ™€ role κ²€μ¦μ—λ§ μ‹ κ²½μ„ μΌμµλ‹λ‹¤.

5. μ»¨νΈλ΅¤λ¬ μ—”λ“ν¬μΈνΈ λ§µν•‘μ—λ”, μ „μ—­μΌλ΅ '/api ', λ¨λ“ μ§€μ •μ„ μ„ν•΄ κ° λ¨λ“ μ΄λ¦„, κ·Έ λ’¤μ— μ‹¤μ  μ„λ²„μ μ—”λ“ν¬μΈνΈλ¥Ό μ‘μ„±ν•λ„λ΅ κµ¬μ„±ν•μ€μµλ‹λ‹¤. κ·Έλ¬λ©΄ event μ„λ²„λ΅μ μ”μ²­μΌ κ²½μ° /api/event/event κ°™μ€ μ—”λ“ν¬μΈνΈκ°€ μƒμ„±λμ§€λ§, μ €λ” κ° λ¨λ“λ³„λ΅ ν•λ‚μ μ„λ²„λ΅ μ”μ²­ν•λ” κ²ƒμ„ μ›ν–μµλ‹λ‹¤. ν„μ¬λ” λ‘κ°μ μ„λ²„μ™€ ν†µμ‹ ν•μ§€λ§ ν›¨μ”¬ λ” λ§μ€ μ„λ²„μ™€ ν†µμ‹ μ΄ ν•„μ”ν•΄μ§€λ©΄ μ΄μ™€ κ°™μ€ κµ¬μ„±μ΄ μ§κ΄€μ μ΄λΌκ³  μƒκ°ν–μµλ‹λ‹¤.

6. μ„λΉ„μ¤ λ‹¨μ—μ„λ” ν™κ²½λ³€μμ— λ“±λ΅λ κ° λ¨λ“λ³„ PREFIXλ¥Ό μ§€μ΄ ν›„ νƒ€κ² μ„λ²„μ— μ•λ§μ€ μ—”λ“ν¬μΈνΈλ΅ λ³€ν™ν•μ—¬ HttpProxy μ„λΉ„μ¤μ λ©”μ„λ“λ¥Ό νΈμ¶ν•λ„λ΅ ν•μ€μµλ‹λ‹¤. μ„λΉ„μ¤ λ‹¨μ—μ„λ„ κµ¬ν„ν• λ©”μ„λ“λ” Http λ©”μ„λ“μ™€ μ΄λ¦„μ„ κ°™κ² κµ¬μ„ν•μ€μµλ‹λ‹¤. (post(), get(), ...)

7. HttpProxyλ” Http λ©”μ„λ“ λ³„λ΅ proxyGet, proxyPost λ“±μΌλ΅ κµ¬ν„ν•μ€μµλ‹λ‹¤.

8. μµμ΄ ν†µμ‹  ν…μ¤νΈλ¥Ό μ„ν•΄ μ‘μ„±ν• http μ”μ²­ λ©”μ„λ“λ¥Ό μ λ„λ¦­μΌλ΅ λ§λ“¤κ³  λ²”μ©μΌλ΅ μ‚¬μ©ν•λ ¤ ν–μ§€λ§, μ½”λ“μ κΈΈμ΄κ°€ λ„λ¬΄ κΈΈμ–΄μ§€κ³  μ λ„λ¦­ νƒ€μ…λ“¤λ΅ μΈν• μ½”λ“μ κ°€λ…μ„± μ €ν•λ΅ μ„μ™€ κ°™μ΄ κµ¬ν„ λ°©μ‹μ„ λ³€κ²½ν•μ€μµλ‹λ‹¤.

9. gwμ—μ„ μΈμ¦/μΈκ°€ μ΄ν›„ tokenμΌλ΅ λ¶€ν„° μ–»μ–΄λ‚Έ λ°μ΄ν„°λ“¤μ€, proxy μ”μ²­ μ‹ μ”μ²­ ν—¤λ”μ ν‚¤κ°’μ„ μ§€μ •ν•μ—¬ νƒ€κΉƒ μ„λ²„λ΅ μ „μ†΅ν•μ€μµλ‹λ‹¤. Write μ‘μ—… μ‹ ν—¤λ”μ κ°’, νλΌλ―Έν„°μ κ°’, dbμ μ €μ¥λμ–΄ μλ” id κ°’ λ“±μ„ μ΄μ©ν•μ—¬ κ¶ν• ν™•μΈμ„ μƒμ„Έν ν•  μ μλ‹¤κ³  μƒκ°ν–μµλ‹λ‹¤.

## λ³΄μ™„ν•  μ 

1. μµμ΄μ—λ” gateway μ—μ„ μ–΄λ–¤ λ°μ΄ν„°λ“¤μ΄ μ €μ¥μ΄ ν•„μ”ν• κΉ μ‹¶μ—μµλ‹λ‹¤. ν•μ§€λ§ μ„λ²„ access logλ¥Ό gateway μ—μ„ μ €μ¥ν•λ‹¤λ©΄, νƒ€ μ„λ²„μ μ§μ„ λμ–΄μ¤„ μ μμ„ κ²ƒ κ°™λ‹¤κ³  μƒκ°ν–μµλ‹λ‹¤.

2. μ‘λ‹µ κ°’μ„ κ° μ„λΉ„μ¤ λ‹¨ λ‚΄μ—μ„ wrapReturnForm μΌλ΅ κ°μ‹Έμ£Όμ—κΈ΄ ν•μ§€λ§ κ° μ„λΉ„μ¤ λ‹¨μ΄ μ•„λ‹ κ³µν†µμΌλ΅ μ λ„λ¦­ νƒ€μ…μ„ λ§λ“¤μ§€ λ»ν• κ²ƒμ΄ μ•„μ‰½μµλ‹λ‹¤. μ‘μ—…μ„ μ§„ν–‰ν•λ‹¤λ©΄, μ”μ²­ μ„±κ³µ μ‹μ κ³µν†µλ ν•νƒμ κ°μ²΄ ν¬λ§·μ„ μ •ν•κ³  μ”μ²­μ΄ μ‹¤ν¨ν–μ„ λ•μ νΌμ„ κµ¬μ„±ν•μ—¬ ν•λ‚μ νƒ€μ…μΌλ΅ μ„ μ–Έν•κ³ μ ν•©λ‹λ‹¤.

3. {api}/{modulename}/{path}/{to}/{target} μ‹μΌλ΅ κµ¬ν„ν• λ¶€λ¶„μ€, ν†µμ‹  μ„λ²„μ κ°μλ§ μƒκ°ν•μ—¬ μλ» μ„¤κ³„λμ—λ‹¤κ³  μƒκ°ν•©λ‹λ‹¤. νƒ€κΉƒ μ„λ²„μ μ—”λ“ν¬μΈνΈκ°€ λ§μ•„μ§ μλ΅ gateway μ„λ²„ ν• κ°μ controllerλ” λ„λ¬΄ κΈΈμ–΄μ§€κ² λ©λ‹λ‹¤. λ³΄μ™„ μ‘μ—…μ„ ν•λ‹¤λ©΄ auth λ¨λ“μ€ auth μ„λ²„μ™€ ν†µμ‹ ν•λ‹¤λ” κ²ƒμ€ λ² μ΄μ¤λ΅ μ§„ν–‰ν•κ³  μ‹¤μ  auth μ„λ²„μ λ‚λ μ§€λ” μ»¨νΈλ΅¤λ¬ prefixμ— λ§κ² μ—”λ“ν¬μΈνΈ controllerλ¥Ό μƒμ„±ν•μ—¬ gatewayμ auth moduleμ—μ„ controllerλ“¤μ„ μΌκ΄„ λ“±λ΅ν•λ” λ°©μ‹μΌλ΅ μ‘μ—…ν•  μƒκ°μ…λ‹λ‹¤.
